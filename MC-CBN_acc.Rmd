---
title: "CAPRI"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Let's start by making the graph 

```{r}
G <- matrix(0, nrow = 21, ncol = 21)

G[1,2]=1
G[1,3]=1
G[1,4]=1
G[1,5]=1
G[1,6]=1
G[2,7]=1
G[2,8]=1
G[2,9]=1
G[3,8]=1
G[3,9]=1
G[3,10]=1
G[4,11]=1
G[4,12]=1
G[5,13]=1
G[5,14]=1
G[8,15]=1
G[9,16]=1
G[9,17]=1
G[10,18]=1
G[10,19]=1
G[11,20]=1
G[12,20]=1
G[13,20]=1
G[14,21]=1

G_cut <- G[-1,-1]
print(G)

```


Now we bring out some code to generate synthetic data that I wrote a long time ago
```{r}
Parents <- function(graph, node)
{
  return(which(graph[node,] != 0))
}

Generate_Data <- function(graph, Vseq, theta, N, false_pos, false_neg)
{
  p <- nrow(graph)
  Synthetic_Data <- matrix(0, nrow = N, ncol = p)
  
  for(i in 1:N)
  {
    for(j in Vseq)
    {
      parents <- Parents(graph, j)
      
      if(length(parents) != 0)
      {
        if(length(which(Synthetic_Data[i, parents] != 0)) != length(parents))
        {
          Synthetic_Data[i, j] = 0
        }
        else
        {
          coin_flip = rbinom(1, 1, theta[j])
          if(coin_flip == 1)
          {
            Synthetic_Data[i, j] = 1
          }
          else
          {
            Synthetic_Data[i,j] = 0
          }
        }
      }
      else{
        Synthetic_Data[i,j]=rbinom(1,1,theta[j])
      }
    }
  }
  
  for(i in 1:N)
  {
    for(j in 1:p)
    {
      if(Synthetic_Data[i,j] == 1)
      {
        Synthetic_Data[i,j] = rbinom(1, 1, 1 - false_pos)
      }
      else
      {
        Synthetic_Data[i,j] = rbinom(1, 1, false_neg)
      }
    }
  }
  return(as.data.frame(Synthetic_Data))
}
```


Let's set theta
```{r}
set.seed(9882771)
theta <- runif(21, min = 0.45, max = 0.9)
```

Load the packages 
```{r}
library(OncoBN)
library(mccbn)
library(igraph)
```

Now for the comparison 

```{r}
comparemccbn <- function(N, fpr, fnr, iters) {
  cbnprec<- c(1:iters)
  cbnrecall <- c(1:iters)
  dpprec <- c(1:iters)
  dprecall <- c(1:iters)
  
  cbn_hamming <- c(1:iters)
  dp_hamming <- c(1:iters)
  
  for(i in 1:iters) {
    print(i)
    D <- matrix(0,nrow = 20, ncol = 20)
    while(min(colMeans(D)) < 0.05) {
    theta <- runif(20,min=0.25, max = 0.75)
    mydag <- randDAG(n=20, d=2, method = "er")
    mydag <- igraph.from.graphNEL(mydag)
    Vseq <- topo_sort(mydag)
  
    G <- as_adjacency_matrix(mydag)  

  
    D <- Generate_Data(t(as.matrix(G)), Vseq, theta, N, fpr, fnr)       
    }
    
    colnames(D) <- c(1:20)
    
    Dnew <- cbind(1,D)
    
    fit = learn_network(as.matrix(Dnew))
    mle_index = which.max(fit$logliks)
    M <- fit$posets[[mle_index]]
    M <- M[-1,-1]
    
    fn <- sum(M - G  < 0)
    fp <- sum(G - M < 0)
    
    cbnprec[i] <- (sum(G)-fn)/((sum(G)-fn)+fp)
    cbnrecall[i] <- (sum(G)-fn)/(sum(G))
    cbn_hamming[i] <- sum(G != M)
    
    
    out <- fitCPN(D, model = "CBN", k = 5, epsilon = min(colMeans(D))/2, verbose = FALSE)
    graph <- make_directed_graph(out$edgelist)
    M <- as_adjacency_matrix(graph)
    wtindex <- which(rownames(M) == "WT")
    M <- M[-wtindex,-wtindex]
    perm <- order(as.integer(rownames(M)))
    M <- M[perm, perm]
    
    fn <- sum(M - G < 0)
    fp <- sum(G - M < 0)
    
    dpprec[i] <- (sum(G)-fn)/((sum(G)-fn)+fp)
    dprecall[i] <- (sum(G)-fn)/(sum(G))
    dp_hamming[i] <- sum(G != M)
    cat(cbn_hamming[i], " ", dp_hamming[i], "\n")
  }
  
  returnlist <- list()
  returnlist[[1]] <- cbn_hamming
  returnlist[[2]] <- dp_hamming
  return(returnlist)
}
```

Now for the experiment 
```{r}
eta <- c(0.0,0.01,0.02,0.03,0.04,0.05,0.075,0.1,0.15,0.2)
library(pcalg)
set.seed(9882771)
cbn_hamming <-  matrix(0, nrow = 50, ncol = length(eta))
dp_hamming <- matrix(0, nrow = 50, ncol = length(eta))

for(i in 1:length(eta)) {
  print("NEW")
  print(i)
  mylist <- comparemccbn(N = 400, fpr = eta[i], fnr = eta[i], iters = 50)
  cbn_hamming[,i] <- mylist[[1]]
  dp_hamming[,i] <- mylist[[2]]
}

write.csv(cbn_hamming, file = "/Users/phillipnicol/Desktop/local_files/data/CPN_DP_DATA/cbnHAMMING.csv")
write.csv(dpmcc, file = "/Users/phillipnicol/Desktop/local_files/data/CPN_DP_DATA/dp_cbnHAMMING.csv")

```


