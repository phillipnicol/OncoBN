---
title: "CAPRI"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Let's start by making the graph 

```{r}
G <- matrix(0, nrow = 21, ncol = 21)

G[1,2]=1
G[1,3]=1
G[1,4]=1
G[1,5]=1
G[1,6]=1
G[2,7]=1
G[2,8]=1
G[2,9]=1
G[3,8]=1
G[3,9]=1
G[3,10]=1
G[4,11]=1
G[4,12]=1
G[5,13]=1
G[5,14]=1
G[8,15]=1
G[9,16]=1
G[9,17]=1
G[10,18]=1
G[10,19]=1
G[11,20]=1
G[12,20]=1
G[13,20]=1
G[14,21]=1

G_cut <- G[-1,-1]
print(G)

```


Now we bring out some code to generate synthetic data that I wrote a long time ago
```{r}
Parents <- function(graph, node)
{
  return(which(graph[node,] != 0))
}

Generate_Data <- function(graph, theta, N, false_pos, false_neg)
{
  V <- nrow(graph)
  Synthetic_Data <- matrix(1, nrow = N, ncol = V)
  
  for(i in 1:N)
  {
    for(j in 1:V)
    {
      parents <- Parents(graph, j)
      
      if(length(parents) != 0)
      {
        if(length(which(Synthetic_Data[i, parents] != 0)) != length(parents))
        {
          Synthetic_Data[i, j] = 0
        }
        else
        {
          coin_flip = rbinom(1, 1, theta[j])
          if(coin_flip == 1)
          {
            Synthetic_Data[i, j] = 1
          }
          else
          {
            Synthetic_Data[i,j] = 0
          }
        }
      }
    }
  }
  
  for(i in 1:N)
  {
    for(j in 2:V)
    {
      if(Synthetic_Data[i,j] == 1)
      {
        Synthetic_Data[i,j] = rbinom(1, 1, 1 - false_pos)
      }
      else
      {
        Synthetic_Data[i,j] = rbinom(1, 1, false_neg)
      }
    }
  }
  return(as.data.frame(Synthetic_Data))
}
```


Let's set theta
```{r}
set.seed(9882771)
theta <- runif(21, min = 0.45, max = 0.9)
```

Load the packages 
```{r}
library(OncoBN)
library(mccbn)
library(igraph)
```

Now for the comparison 

```{r}
comparemccbn <- function(G, theta, N, fpr, fnr, iters) {
  cbnfp<- c(1:iters)
  cbnfn <- c(1:iters)
  dpfn <- c(1:iters)
  dpfp <- c(1:iters)
  
  G_t <- G[-1,-1]
  
  for(i in 1:iters) {
    D <- Generate_Data(t(G), theta, N, fpr, fnr) 
    D <- as.matrix(D) 
    
    fit = learn_network(D)
    mle_index = which.max(fit$logliks)
    M <- fit$posets[[mle_index]]
    M <- M[-1,-1]
    
    print(M)
    
    cbnfn[i] <- sum(M - G_t  < 0)
    cbnfp[i] <- sum(G_t - M < 0)
    
    D <- D[,-1]
    colnames(D) <- c(1:20) 
    
    out <- fitCPN(D, model = "CBN", k = 3, epsilon = min(colMeans(D))/2, verbose = FALSE)
    graph <- make_directed_graph(out$edgelist)
    M <- as_adjacency_matrix(graph)
    wtindex <- which(rownames(M) == "WT")
    M <- M[-wtindex,-wtindex]
    perm <- order(as.integer(rownames(M)))
    M <- M[perm, perm]
    
    dpfn[i] <- sum(M - G_t < 0)
    dpfp[i] <- sum(G_t - M < 0)
  }
  
  returnlist <- list()
  returnlist[[1]] <- cbnfn
  returnlist[[2]] <- cbnfp
  returnlist[[3]] <- dpfn
  returnlist[[4]] <- dpfp
  return(returnlist)
}
```

```{r}
filepath <- "/Users/p"
```

Now for the experiment 
```{r}
eta <- c(0.0,0.01,0.02,0.03,0.04,0.05,0.075,0.1,0.15,0.2)

set.seed(9882771)
caprifp <-  matrix(0, nrow = 100, ncol = length(eta))
caprifn <- matrix(0, nrow = 100, ncol = length(eta))
dpfp <- matrix(0, nrow = 100, ncol = length(eta))
dpfn <- matrix(0, nrow = 100, ncol = length(eta))

for(i in 1:length(eta)) {
  mylist <- comparecapri(G, theta, N = 400, fpr = eta[i], fnr = eta[i], iters = 100)
  caprifn[,i] <- mylist[[1]]
  caprifp[,i] <- mylist[[2]]
  dpfn[,i] <- mylist[[3]]
  dpfp[,i] <- mylist[[4]] 
}

write.csv(caprifn, file = "/Users/phillipnicol/Desktop/local_files/caprifn.csv")
write.csv(caprifp, file = "/Users/phillipnicol/Desktop/local_files/caprifp.csv")
write.csv(dpfn, file = "/Users/phillipnicol/Desktop/local_files/dpfn.csv")
write.csv(dpfp, file = "/Users/phillipnicol/Desktop/local_files/dpfp.csv")
```


